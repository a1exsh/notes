<!-- $ chromium --allow-file-access-from-files ./yin-yang.html -->
<html>
  <head>
    <script>
      const sampling = 10;
      const lightnessThreshold = 0.75;

      const isDarkMode = true; // learn this somehow

      function processImage(image) {
          const width  = image.width;
          const height = image.height;

          // don't bother with images that are to small
          if (width * height < 64*64) {
              return;
          }

          const sw = Math.round(width  / sampling + 0.5);
          const sh = Math.round(height / sampling + 0.5);

          const canvas = new OffscreenCanvas(sw, sh);
          //const canvas = document.getElementById("canwas");

          const ctx = canvas.getContext("2d", {willReadFrequently: true});
          ctx.imageSmoothingEnabled = false;

          ctx.drawImage(image, 0, 0, width, height, 0, 0, sw, sh);

          const imgData = ctx.getImageData(0, 0, sw, sh);
          const pixels = imgData.data;

          const sampleSize = sw * sh;
          const distinctColorsThreshold = sampleSize / 10;
          var distinctColors = 0;
          var sampleValue = 0;
          var sampleColors = {};
          var idx = 0;

          for (var y = 0; y < sh; ++y) {
              for (var x = 0; x < sw; ++x) {
                  const r = pixels[idx++];
                  const g = pixels[idx++];
                  const b = pixels[idx++];
                  ++idx;                // ignoring alpha for now

                  const rgb = ((r >> 2) << 16) | ((g >> 2) << 8) | (b >> 2);
                  if (sampleColors[rgb] === undefined) {
                      sampleColors[rgb] = 1;
                      if (++distinctColors > distinctColorsThreshold) {
                          // that's likely not a screenshot, put a photo
                          return;
                      }
                  }

                  sampleValue += r + g + b;
              }
          }

          const lightness = sampleValue / (3*255 * sampleSize);
          const isImageDark = lightness < lightnessThreshold;

          if (isImageDark && !isDarkMode ||
              !isImageDark && isDarkMode) {
              image.style.setProperty("filter", "invert(100%)");
          }
      }

      window.onload = (_event) => {
          for (const image of document.querySelectorAll("img")) {
              processImage(image);
          }
      };
    </script>
  </head>
  <body>
    <h1>Yin & Yang</h1>
    <!--canvas id="canwas" width="256" height="256">
        debugging
    </canvas-->
    <p>
      Here is some filler text.  Here is some filler text.  Here is some
      filler text.  Here is some filler text.  Here is some filler text.  Here
      is some filler text.  Here is some filler text.
    </p>
    <img src="resources/rick.jpg" />
    <div>
      <p>
        More text here.
      </p>
      <img src="resources/screenshots/light/emacs.png" />
      <!-- style="width: 75%" -->
    </div>
  </body>
</html>
